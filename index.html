<!DOCTYPE html>
<html>
<head>
    <title>QR/ID Data Management</title>
    <style>
        body { font-family: sans-serif; }
        #video { width: 300px; height: 225px; border: 1px solid black; }
        #results { margin-top: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid black; padding: 8px; text-align: left; }
    </style>
</head>
<body>
    <h1>QR/ID Data Management</h1>

    <input type="text" id="idInput" placeholder="Enter ID">
    <button id="idButton">Submit ID</button>

    <video id="video"></video>
    <button id="scanButton">Scan QR Code</button>

    <div id="results"></div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
        const video = document.getElementById('video');
        const canvasElement = document.createElement('canvas');
        const canvas = canvasElement.getContext('2d');
        const resultsDiv = document.getElementById('results');
        const scanButton = document.getElementById('scanButton');
        const idButton = document.getElementById('idButton');
        const idInput = document.getElementById('idInput');

        const spreadsheetId = '1YJTMuVnSkcieTWD7HK6o51QR10mKoTYkBxnJDKeCkuQ'; // Replace
        const apiKey = 'AIzaSyCi64r2af807aNMnsEPH_TJ4D90N40cHAs'; // Replace
        const range = 'Sheet3'; // Replace

        function drawLine(begin, end, color) {
            canvas.beginPath();
            canvas.moveTo(begin.x, begin.y);
            canvas.lineTo(end.x, end.y);
            canvas.lineWidth = 4;
            canvas.strokeStyle = color;
            canvas.stroke();
        }

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
                    drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
                    drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
                    drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");

                    resultsDiv.innerHTML = `<p>QR Code Data: ${code.data}</p>`;
                    processData(code.data);
                }
            }
            requestAnimationFrame(tick);
        }

        scanButton.addEventListener('click', () => {
             navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(stream) {
                video.srcObject = stream;
                video.setAttribute("playsinline", true);
                video.play();
                requestAnimationFrame(tick);
            });
        });

        idButton.addEventListener('click', () => {
            const id = idInput.value;
            if (id) {
                processId(id);
            }
        });

        function processId(id) {
            checkIdExists(id).then(exists => {
                if (exists) {
                    viewData(id);
                } else {
                    createData(id);
                }
            });
        }

        function processData(qrData) {
            try {
                const data = JSON.parse(qrData);
                if (data && data.id) {
                    processId(data.id);
                } else {
                    resultsDiv.innerHTML += '<p>Invalid QR Code: ID required.</p>';
                }
            } catch (error) {
                resultsDiv.innerHTML += '<p>Error processing QR code: ' + error + '</p>';
            }
        }

        function checkIdExists(id) {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;
            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.values) {
                        return data.values.some(row => row[0] === id);
                    }
                    return false;
                })
                .catch(error => {
                    console.error("Error checking ID:", error);
                    return false;
                });
        }

        function createData(id) {
            const rowData = [id, "Default Value"]; // Customize as needed.
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}:append?valueInputOption=RAW&key=${apiKey}`;
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ values: [rowData] })
            })
            .then(response => response.json())
            .then(data => {
                if (data.updates && data.updates.updatedCells > 0) {
                    resultsDiv.innerHTML += `<p>ID ${id} created with default data.</p>`;
                    viewData(id);
                } else {
                    resultsDiv.innerHTML += `<p>Failed to create ID ${id}.</p>`;
                }
            })
            .catch(error => resultsDiv.innerHTML += '<p>Error: ' + error + '</p>');
        }

        function viewData(id) {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.values) {
                        const row = data.values.find(row => row[0] === id);
                        if (row) {
                            let tableHTML = '<table><thead><tr><th>ID</th><th>Value</th></tr></thead><tbody><tr>';
                            row.forEach(cell => tableHTML += `<td>${cell}</td>`);
                            tableHTML += '</tr></tbody></table>';
                            resultsDiv.innerHTML = tableHTML;
                        } else {
                            resultsDiv.innerHTML = `<p>ID ${id} not found.</p>`;
                        }
                    } else {
                        resultsDiv.innerHTML = '<p>No data found.</p>';
                    }
                })
                .catch(error => resultsDiv.innerHTML = `<p>Error fetching data: ${error}</p>`);
        }
    </script>
</body>
</html>
