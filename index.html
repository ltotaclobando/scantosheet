<!DOCTYPE html>
<html>
<head>
    <title>QR Code Google Sheets</title>
    <style>
        body { font-family: sans-serif; }
        #video { width: 300px; height: 225px; border: 1px solid black; }
        #results { margin-top: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid black; padding: 8px; text-align: left; }
    </style>
</head>
<body>
    <h1>QR Code Google Sheets</h1>

    <video id="video"></video>
    <button id="scanButton">Scan QR Code</button>

    <div id="results"></div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
        const video = document.getElementById('video');
        const canvasElement = document.createElement('canvas');
        const canvas = canvasElement.getContext('2d');
        const resultsDiv = document.getElementById('results');
        const scanButton = document.getElementById('scanButton');

        function drawLine(begin, end, color) {
            canvas.beginPath();
            canvas.moveTo(begin.x, begin.y);
            canvas.lineTo(end.x, end.y);
            canvas.lineWidth = 4;
            canvas.strokeStyle = color;
            canvas.stroke();
        }

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
                    drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
                    drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
                    drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");

                    resultsDiv.innerHTML = `<p>QR Code Data: ${code.data}</p>`;
                    processData(code.data);
                }
            }
            requestAnimationFrame(tick);
        }

        scanButton.addEventListener('click', () => {
             navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(stream) {
                video.srcObject = stream;
                video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
                video.play();
                requestAnimationFrame(tick);
            });
        });

        function processData(qrData) {
            try {
                const data = JSON.parse(qrData);

                if (Array.isArray(data)) {
                    // Assuming data is an array of values to add to the sheet.
                    addToSheet(data);
                } else if (typeof data === 'object' && data !== null) {
                    // Assuming data is an object to add to the sheet.
                    addToSheet(Object.values(data));
                } else if (qrData.toLowerCase() === 'view'){
                    viewSheetData();
                } else {
                    resultsDiv.innerHTML += '<p>Invalid QR Code Format.</p>';
                }
            } catch (error) {
                resultsDiv.innerHTML += '<p>Error processing QR code: ' + error + '</p>';
            }
        }

        function addToSheet(rowData) {
            const spreadsheetId = '1YJTMuVnSkcieTWD7HK6o51QR10mKoTYkBxnJDKeCkuQ'; // Replace with your Sheet ID
            const apiKey = 'AIzaSyCi64r2af807aNMnsEPH_TJ4D90N40cHAs'; // Replace with your API key.
            const range = 'Data'; // Replace with your sheet name if needed
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}:append?valueInputOption=RAW&key=${apiKey}`;

            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ values: [rowData] })
            })
            .then(response => response.json())
            .then(data => {
                if (data.updates && data.updates.updatedCells > 0) {
                    resultsDiv.innerHTML += '<p>Data added to Google Sheets.</p>';
                } else {
                    resultsDiv.innerHTML += '<p>Failed to add data to Google Sheets.</p>';
                }
            })
            .catch(error => resultsDiv.innerHTML += '<p>Error: ' + error + '</p>');
        }

        function viewSheetData() {
            const spreadsheetId = '1YJTMuVnSkcieTWD7HK6o51QR10mKoTYkBxnJDKeCkuQ'; // Replace with your Sheet ID
            const apiKey = 'AIzaSyCi64r2af807aNMnsEPH_TJ4D90N40cHAs';//replace with your API key.
            const range = 'Data'; // Replace with your sheet name if needed
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.values && data.values.length > 0) {
                        const header = data.values[0];
                        const rows = data.values.slice(1);
                        let tableHTML = '<table><thead><tr>';
                        header.forEach(h => tableHTML += `<th>${h}</th>`);
                        tableHTML += '</tr></thead><tbody>';
                        rows.forEach(row => {
                            tableHTML += '<tr>';
                            row.forEach(cell => tableHTML += `<td>${cell}</td>`);
                            tableHTML += '</tr>';
                        });
                        tableHTML += '</tbody></table>';
                        resultsDiv.innerHTML = tableHTML;
                    } else {
                        resultsDiv.innerHTML = '<p>No data found in Google Sheets.</p>';
                    }
                })
                .catch(error => resultsDiv.innerHTML = `<p>Error fetching data: ${error}</p>`);
        }
    </script>
</body>
</html>
